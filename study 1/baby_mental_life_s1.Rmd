---
title: "Baby Mental Life: Study 1"
date: 2018-07-31
output: 
  html_notebook:
    toc: true
    toc_float: true
---

```{r global_options, include = F}
knitr::opts_chunk$set(fig.width = 3, fig.asp = 0.67)
```


"Baby Mental Life: Study 1" was conducted on MTurk on 2018-07-31.

Our planned sample was 300 participants, and we anticipated that roughly 85-90% of recruited participants would pass all of our attention checks, so we initially recruited 342 participants. After filtering out participants who failed at least one of our attention checks, we ended up retaining only XX participants, so we recruited an additional XX participants. In the end, we ended up with a sample of XX participants who passed our attention checks (out of XX participants recruited in total).

Each participant assessed children's mental capacities at 3 target ages: newborns, 9-month-olds, and 5-year-olds. For each target, they rated 60 mental capacities on a scale from 0 (not at all capable) to 100 (completely capable). 

For more details about the study, see our preregistration [here](https://osf.io/e6ajh/). 

```{r}
# load required libraries
library(tidyverse)
library(langcog) # source: https://github.com/langcog/langcog-package
library(psych)

# set theme for ggplots
theme_set(theme_bw())
```

```{r}
# run source code (extra functions)
source("./scripts/max_factors_efa.R")

# make function for implementing criteria
reten_fun <- function(df, rot_type = c("oblimin", "varimax", "none")){
  
  # figure out max number of factors to retain
  n_var <- length(names(df))
  max_k <- max_ok(n_var)
  
  # run efa with max factors, unrotated
  fa_unrot <- fa(df, nfactors = max_k, rotate = "none")
  eigen <- fa_unrot$Vaccounted %>%
    data.frame() %>%
    rownames_to_column("param") %>%
    gather(factor, value, -param) %>%
    spread(param, value) %>%
    filter(`SS loadings` > 1, `Proportion Explained` > 0.05)
  retain_k <- nrow(eigen)
  
  fa_rot <- fa(df, nfactors = retain_k, rotate = rot_type)
  loadings <- fa_rot$loadings[] %>%
    data.frame() %>%
    rownames_to_column("capacity") %>%
    gather(factor, loading, -capacity) %>%
    group_by(capacity) %>%
    top_n(1, abs(loading)) %>%
    ungroup() %>%
    count(factor)
  retain_k_final <- nrow(loadings)
  
  return(retain_k_final)
}

# make function for generating heatmap
heatmap_fun <- function(efa){
  
  # get factor loadings
  loadings <- efa$loadings[] %>%
    data.frame() %>%
    rownames_to_column("capacity") %>%
    gather(factor, loading, -capacity)
  
  # get fa.sort() order
  order <- loadings %>%
    group_by(capacity) %>%
    top_n(1, abs(loading)) %>%
    ungroup() %>%
    arrange(factor, abs(loading)) %>%
    mutate(order = 1:length(levels(factor(loadings$capacity)))) %>%
    select(capacity, order)
  
  # make plot
  plot <- ggplot(loadings %>% 
                   left_join(order) %>%
                   mutate(capacity = gsub("_", " ", capacity)),
                 aes(x = factor, 
                     y = reorder(capacity, order), 
                     fill = loading, 
                     label = format(round(loading, 2), nsmall = 2))) +
    geom_tile(color = "black") +
    geom_text(size = 3) +
    scale_fill_distiller(limits = c(-1, 1), 
                         palette = "RdYlBu",
                         guide = guide_colorbar(barheight = 20)) +
    theme_minimal() +
    scale_x_discrete(position = "top") +
    labs(x = "", y = "")
  
  return(plot)

}

# make function for plotting factor scores by factor, target
scoresplot_fun <- function(efa, 
                          target = c("all", "newborns", "9-month-olds", "5-year-olds")){
  
  # generate list of targets
  target_list <- case_when(
    target == "all" ~ c("target00mo", "target09mo", "target60mo"),
    target == "newborns" ~ "target00mo",
    target == "9-month-olds" ~ "target09mo",
    target == "5-year-olds" ~ "target60mo"
  )
  
  # make usable dataframe
  df <- efa$scores[] %>%
    data.frame() %>%
    rownames_to_column("subid") %>%
    mutate(ResponseId = gsub("_target.*$", "", subid),
           target = gsub("R_.*_", "", subid)) %>%
    filter(target %in% target_list) %>%
    select(-subid) %>%
    gather(factor, score, -c(ResponseId, target)) %>%
    mutate(target = recode_factor(target,
                                  "target00mo" = "newborns",
                                  "target09mo" = "9-month-olds",
                                  "target60mo" = "5-year-olds"))
  
  # get bootstrapped means
  df_boot <- df %>%
    group_by(target, factor) %>%
    multi_boot_standard("score", na.rm = T) %>%
    ungroup()
  
  # get first items for each factor
  first_items <- efa$loadings[] %>%
    data.frame() %>%
    rownames_to_column("capacity") %>%
    gather(factor, loading, -capacity) %>%
    group_by(factor) %>%
    top_n(3, abs(loading)) %>%
    mutate(capacity = gsub("_", " ", capacity),
           cap_list = str_c(capacity, collapse = ", "),
           cap_list = paste0(cap_list, "...")) %>%
    ungroup() %>%
    select(-capacity, -loading) %>%
    distinct()

  # make plot
  plot <- ggplot(df,
                 aes(x = target, 
                     y = score, 
                     color = factor)) +
    facet_grid(~ factor) +
    geom_path(aes(group = ResponseId), alpha = 0.1) +
    geom_path(data = df_boot,
              aes(y = mean, group = factor), color = "black", lty = 2) +
    geom_pointrange(data = df_boot,
                    aes(y = mean, ymin = ci_lower, ymax = ci_upper),
                    color = "black", fatten = 0.75) +
    geom_text(data = first_items,
              aes(label = gsub('(.{1,30})(\\s|$)', '\\1\n', cap_list)),
              x = 0.5, y = max(df$score), size = 3, color = "black",
              hjust = 0, vjust = 1) +
    theme_bw() +
    labs(x = "target", y = "factor score",
         subtitle = "Error bars are bootstrapped 95% confidence intervals") +
    guides(color = "none")
    # guides(color = guide_legend(override.aes = list(alpha = 1, size = 1)))
  
  return(plot)
  
}

# make function for plotting individual item means by factor, target
itemsplot_fun <- function(efa,
                          target = c("all", "newborns", "9-month-olds", "5-year-olds")){
  
  # generate list of targets
  target_list <- case_when(
    target == "all" ~ c("target00mo", "target09mo", "target60mo"),
    target == "newborns" ~ "target00mo",
    target == "9-month-olds" ~ "target09mo",
    target == "5-year-olds" ~ "target60mo"
  )
  
  # make usable dataframe
  df <- d_all %>%
    rownames_to_column("subid") %>%
    mutate(ResponseId = gsub("_target.*$", "", subid),
           target = gsub("R_.*_", "", subid)) %>%
    filter(target %in% target_list) %>%
    select(-subid) %>%
    gather(capacity, response, -c(ResponseId, target)) %>%
    mutate(target = recode_factor(target,
                                  "target00mo" = "newborns",
                                  "target09mo" = "9-month-olds",
                                  "target60mo" = "5-year-olds"))
  
  # get factor loadings
  loadings <- efa$loadings[] %>%
    data.frame() %>%
    rownames_to_column("capacity") %>%
    gather(factor, loading, -capacity)
  
  # get fa.sort() order
  order <- efa$loadings[] %>%
    data.frame() %>%
    rownames_to_column("capacity") %>%
    gather(factor, loading, -capacity) %>%
    group_by(capacity) %>%
    top_n(1, abs(loading)) %>%
    ungroup() %>%
    arrange(factor, abs(loading)) %>%
    mutate(order = 1:length(levels(factor(loadings$capacity)))) %>%
    select(factor, capacity, order)
  
  # add order to df
  df <- df %>% left_join(order)
  
  # get bootstrapped means
  df_boot <- df %>%
    group_by(target, factor, capacity, order) %>%
    multi_boot_standard("response", na.rm = T) %>%
    ungroup() %>%
    mutate(capacity = gsub("_", " ", capacity))
    
  # make plot
  plot <- ggplot(df %>% 
                   left_join(order) %>%
                   mutate(capacity = gsub("_", " ", capacity)),
                 aes(x = response, 
                     y = reorder(capacity, order), 
                     color = factor)) +
    facet_grid(factor ~ target, scales = "free", space = "free") +
    geom_point(alpha = 0.02) +
    geom_errorbarh(data = df_boot, 
                   aes(xmin = ci_lower, xmax = ci_upper, x = NULL),
                   color = "black", height = 0) +
    geom_point(data = df_boot,
               aes(x = mean),
               color = "black", size = 2) +
    theme_bw() +
    labs(x = "response", y = "",
         subtitle = "Error bars are bootstrapped 95% confidence intervals") +
    guides(color = "none")
    # guides(color = guide_legend(override.aes = list(alpha = 1, size = 2)))
  
  return(plot)
  
}

```


# Data preparation

```{r}
# load in raw data
d0 <- read.csv("./data/Baby mental life: Study 1_August 1, 2018_04.38.csv")
```

```{r}
# make question key
question_key <- d0[1,] %>%
  t() %>%
  data.frame() %>%
  rownames_to_column("question_qualtrics") %>%
  rename("question_text" = X1) %>%
  mutate(question = recode(question_qualtrics,
                           "Duration..in.seconds." = "Duration",
                           "Q2" = "Age",
                           "Q3" = "GenderSex",
                           "Q3_3_TEXT" = "GenderSex_fillIn",
                           "Q4" = "EnglishProf",
                           "Q5" = "FirstLang",
                           "Q5_2_TEXT" = "FirstLang_fillIn",
                           "Q18" = "RaceEthnicity",
                           "Q18_10_TEXT" = "RaceEthnicity_fillIn",
                           "Q19" = "Education",
                           "Q20" = "Income",
                           "Q21" = "MaritalStatus",
                           "Q21_6_TEXT" = "MaritalStatus_fillIn",
                           "Q22" = "HouseholdSize",
                           "Q23" = "Parent",
                           "Q25" = "ChildrenNumber",
                           "Q26" = "ChildrenYoungestAge",
                           "Q26_1_TEXT" = "ChildrenYoungestAge_fillIn1",
                           "Q26_2_TEXT" = "ChildrenYoungestAge_fillIn2",
                           "Q27" = "ChildrenOldestAge",
                           "Q27_1_TEXT" = "ChildrenOldestAge_fillIn1",
                           "Q27_2_TEXT" = "ChildrenOldestAge_fillIn2",
                           "Q28" = "Attention",
                           "Q29" = "Comments",
                           .default = question_qualtrics),
         question = case_when(grepl("the following questions", question_text) ~
                                gsub("^.*extent is a ", "", question_text),
                              TRUE ~ question),
         question = case_when(grepl("capable of...", question_text) ~
                                gsub("capable of... ", "", tolower(question)),
                              TRUE ~ question),
         question = gsub(" ", "_", question),
         question = gsub("'", "", question),
         question = gsub("newborn_-_", "target00mo_", question),
         question = gsub("9-month-old_-_", "target09mo_", question),
         question = gsub("5-year-old_-_", "target60mo_", question)) %>%
  mutate(question = gsub("-", "_", question),
         question = gsub(" \\(for_example,_smooth,_rough\\)", "", question))
```

```{r}
# rename questions
d1 <- d0 %>%
  filter(grepl("R_", ResponseId)) %>% # get rid of extra info in first two rows
  gather(question_qualtrics, response, -ResponseId) %>%
  left_join(question_key %>% select(question_qualtrics, question)) %>%
  select(-question_qualtrics) %>%
  spread(question, response)
```

```{r}
# implement inclusion/exclusion criteria
d2 <- d1 %>%
  filter(Age >= 18, Age <= 45,
         EnglishProf %in% c("Advanced", "Superior"),
         `target00mo_please_select_34` == 34,
         `target09mo_please_select_90` == 90,
         `target60mo_please_select_4` == 4,
         Attention == "Yes")
```

```{r}
# recode variables & drop extraneous variables
d3 <- d2 %>%
  select(-c(DistributionChannel, EndDate, ExternalReference, Finished, IPAddress, 
            starts_with("Location"), MTurkCode, payment, Progress, 
            starts_with("Recipient"), RecordedDate, StartDate, Status, 
            timeEstimate, UserLanguage)) %>%
  mutate_at(vars(c(starts_with("target"), Age, ChildrenNumber, 
                   ChildrenOldestAge_fillIn1, ChildrenOldestAge_fillIn2, 
                   ChildrenYoungestAge_fillIn1, ChildrenYoungestAge_fillIn2,
                   Duration, HouseholdSize)),
            funs(as.numeric(.))) %>%
  mutate(Education = factor(Education,
                            levels = c("No schooling completed", 
                                       "Nursery school to 8th grade", 
                                       "Some high school, no diploma", 
                                       "High school graduate, diploma or equivalent (including GED)", 
                                       "Some college credit, no degree", 
                                       "Trade school, technical school, or vocational school",
                                       "Associate's degree (for example, AA, AS)",
                                       "Bachelor's degree (for example, BA, BS)",
                                       "Master's degree (for example, MA, MS)",
                                       "Doctor or professional degree (for example, PhD, JD, MD, MBA)")),
         Income = factor(Income,
                         levels = c("$5,001 - 15,000", 
                                    "$15,001 - 30,000", 
                                    "$30,001 - 60,000",
                                    "$60,001 - 90,000",
                                    "$90,001 - 150,000",
                                    "Greater than $150,000",
                                    "Prefer not to say")),
         Parent = factor(Parent,
                         levels = c("No", "Yes")))
```

```{r}
# make useful datasets
# final dataset with all measured variables
d <- d3 %>% distinct()

# demographic information
d_demo <- d %>% 
  select(ResponseId, Duration,
         Age, starts_with("GenderSex"), starts_with("RaceEthnicity"),
         starts_with("FirstLang"),
         Education, Income, HouseholdSize,
         starts_with("MaritalStatus"),
         Parent, starts_with("Children"), 
         Comments) %>%
  mutate(RaceEthnicity_collapse = ifelse(grepl(",([A-Za-z])", RaceEthnicity),
                                         "Multiple", RaceEthnicity)) %>%
  mutate(ChildrenOldestAge_collapse = case_when(
    ChildrenOldestAge %in% c("My oldest child has not yet been born (I am/my partner is pregnant)", "My oldest child is deceased", "Prefer not to say") ~ ChildrenOldestAge,
    ChildrenOldestAge == "In months:" ~ 
      ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    ChildrenOldestAge == "In years:" ~
      ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    TRUE ~ "NA")) %>%
  mutate(ChildrenOldestAge_collapse = 
           factor(ChildrenOldestAge_collapse,
                  levels = c("My oldest child has not yet been born (I am/my partner is pregnant)",
                             "< 1 year",
                             "1 - 3 years",
                             "3 - 5 years",
                             "5 - 10 years",
                             "10 - 18 years",
                             "> 18 years",
                             "My oldest child is deceased",
                             "Prefer not to say"))) %>%
  mutate(ChildrenYoungestAge_collapse = case_when(
    ChildrenYoungestAge %in% c("My youngest child has not yet been born (I am/my partner is pregnant)", "My youngest child is deceased", "Prefer not to say") ~ ChildrenYoungestAge,
    ChildrenYoungestAge == "In months:" ~ 
      ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    ChildrenYoungestAge == "In years:" ~
      ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    TRUE ~ "NA")) %>%
  mutate(ChildrenYoungestAge_collapse = 
           factor(ChildrenYoungestAge_collapse,
                  levels = c("My Youngest child has not yet been born (I am/my partner is pregnant)",
                             "< 1 year",
                             "1 - 3 years",
                             "3 - 5 years",
                             "5 - 10 years",
                             "10 - 18 years",
                             "> 18 years",
                             "My Youngest child is deceased",
                             "Prefer not to say")))  
# all assessments of ALL TARGETS, RepsonseId as rownames
d_all <- d %>% 
  select(ResponseId, starts_with("target"), -contains("please_select")) %>%
  gather(question, response, -ResponseId) %>%
  mutate(target = gsub("_.*$", "", question),
         capacity = gsub("target..mo_", "", question),
         subid = paste(ResponseId, target, sep = "_")) %>%
  select(-ResponseId, -question, -target) %>%
  spread(capacity, response) %>%
  column_to_rownames("subid")

# all assessments of NEWBORNS, RepsonseId as rownames
d_00mo <- d_all %>% 
  rownames_to_column("subid") %>%
  filter(grepl("target00mo", subid)) %>%
  mutate(subid = gsub("target..mo_", "", subid)) %>%
  column_to_rownames("subid")

# all assessments of 9-MONTH-OLDS, RepsonseId as rownames
d_09mo <- d_all %>% 
  rownames_to_column("subid") %>%
  filter(grepl("target09mo", subid)) %>%
  mutate(subid = gsub("target..mo_", "", subid)) %>%
  column_to_rownames("subid")

# all assessments of 5-YEAR-OLDS, RepsonseId as rownames
d_60mo <- d_all %>% 
  rownames_to_column("subid") %>%
  filter(grepl("target60mo", subid)) %>%
  mutate(subid = gsub("target..mo_", "", subid)) %>%
  column_to_rownames("subid")
```


# EFA: all targets

Our primary analysis is an exploratory factor analysis (EFA) collapsing across all 3 target characters (and treating an individual participant's responses to each character as if they were independent data points) - see the preregistration for more details.  

We planned to examine three factor retention protocols in order to determine how many factors to retain: Parallel analysis, minimizing BIC, and a set of preset criteria outlined in Weisman et al. (2017). Here we look at each solution in turn.

## Parallel analysis

### How many factors to retain?

```{r}
reten_all_PA <- fa.parallel(d_all, plot = F); reten_all_PA
reten_all_par <- reten_all_PA$nfact
```

### What are these factors?

```{r}
efa_all_par <- fa(d_all, reten_all_par, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_all_par) + 
  labs(title = "Parallel Analysis") #+
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 0.5, xmax = 1.5, ymin = 1.5, ymax = 21.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 1.5, xmax = 2.5, ymin = 25.5, ymax = 33.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 1.5, xmax = 2.5, ymin = 22.5, ymax = 24.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 2.5, xmax = 3.5, ymin = 33.5, ymax = 34.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 2.5, xmax = 3.5, ymin = 36.5, ymax = 54.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 3.5, xmax = 4.5, ymin = 54.5, ymax = 55.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 3.5, xmax = 4.5, ymin = 56.5, ymax = 57.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 3.5, xmax = 4.5, ymin = 58.5, ymax = 60.5)
```

### Which capacities are attributed to which targets?

```{r, fig.width = 4, fig.asp = 0.5}
scoresplot_fun(efa_all_par, target = "all") + 
  labs(title = "Parallel Analysis") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r, fig.width = 5, fig.asp = 1}
itemsplot_fun(efa_all_par, target = "all") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_all_vss <- VSS(d_all, plot = F); reten_all_vss
reten_all_bic <- data.frame(reten_all_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_all_bic <- fa(d_all, reten_all_bic, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_all_bic) + 
  labs(title = "Minimizing BIC") #+
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 0.5, xmax = 1.5, ymin = 0.5, ymax = 21.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 1.5, xmax = 2.5, ymin = 22.5, ymax = 32.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 2.5, xmax = 3.5, ymin = 32.5, ymax = 48.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 3.5, xmax = 4.5, ymin = 49.5, ymax = 50.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 3.5, xmax = 4.5, ymin = 51.5, ymax = 52.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 4.5, xmax = 5.5, ymin = 52.5, ymax = 54.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 4.5, xmax = 5.5, ymin = 56.5, ymax = 60.5)
```

### Which capacities are attributed to which targets?

```{r, fig.width = 5, fig.asp = 0.4}
scoresplot_fun(efa_all_bic, target = "all") + 
  labs(title = "Minimizing BIC") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r, fig.width = 5, fig.asp = 1}
itemsplot_fun(efa_all_bic, target = "all") + 
  labs(title = "Minimizing BIC")
```


## Preset retention criteria

### How many factors to retain?

```{r}
reten_all_k <- reten_fun(d_all, rot_type = "oblimin")
print(paste("Preset criteria suggest retaining", reten_all_k, "factors"))
```

### What are these factors?

```{r}
efa_all_k <- fa(d_all, reten_all_k, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_all_k) + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)") #+
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 0.5, xmax = 1.5, ymin = 0.5, ymax = 30.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 1.5, xmax = 2.5, ymin = 33.5, ymax = 60.5) +
  # annotate("rect", fill = NA, color = "black", size = 0.5, 
  #          xmin = 1.5, xmax = 2.5, ymin = 30.5, ymax = 31.5)
```

### Which capacities are attributed to which targets?

```{r}
scoresplot_fun(efa_all_k, target = "all") + 
  labs(title = "Preset factor retention criteria (Weisman et al., 2017)")
```

```{r, fig.width = 5, fig.asp = 1}
itemsplot_fun(efa_all_k, target = "all") + 
  labs(title = "Preset factor retention criteria (Weisman et al., 2017)")
```


# EFA: newborns

What happens if we limit ourselves to assessments of newborns' mental capacities?

## Parallel analysis

### How many factors to retain?

```{r}
reten_00mo_PA <- fa.parallel(d_00mo, plot = F); reten_00mo_PA
reten_00mo_par <- reten_00mo_PA$nfact
```

### What are these factors?

```{r}
efa_00mo_par <- fa(d_00mo, reten_00mo_par, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_00mo_par) + 
  labs(title = "Parallel Analysis")
```

### Which capacities are attributed to newborns?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_00mo_par, target = "newborns") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_00mo_vss <- VSS(d_00mo, plot = F); reten_00mo_vss
reten_00mo_bic <- data.frame(reten_00mo_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_00mo_bic <- fa(d_00mo, reten_00mo_bic, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_00mo_bic) + 
  labs(title = "Minimizing BIC") 
```

### Which capacities are attributed to newborns?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_00mo_bic, target = "newborns") + 
  labs(title = "Minimizing BIC")
```


## Preset retention criteria

### How many factors to retain?

```{r}
reten_00mo_k <- reten_fun(d_00mo, rot_type = "oblimin")
print(paste("Preset criteria suggest retaining", reten_00mo_k, "factors"))
```

### What are these factors?

```{r}
efa_00mo_k <- fa(d_00mo, reten_00mo_k, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_00mo_k) + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)") 
```

### Which capacities are attributed to newborns?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_00mo_k, target = "newborns") + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)")
```


# EFA: 9-month-olds

What happens if we limit ourselves to assessments of 9-month-olds' mental capacities?

## Parallel analysis

### How many factors to retain?

```{r}
reten_09mo_PA <- fa.parallel(d_09mo, plot = F); reten_09mo_PA
reten_09mo_par <- reten_09mo_PA$nfact
```

### What are these factors?

```{r}
efa_09mo_par <- fa(d_09mo, reten_09mo_par, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_09mo_par) + 
  labs(title = "Parallel Analysis")
```

### Which capacities are attributed to 9-month-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_09mo_par, target = "9-month-olds") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_09mo_vss <- VSS(d_09mo, plot = F); reten_09mo_vss
reten_09mo_bic <- data.frame(reten_09mo_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_09mo_bic <- fa(d_09mo, reten_09mo_bic, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_09mo_bic) + 
  labs(title = "Minimizing BIC") 
```

### Which capacities are attributed to 9-month-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_09mo_bic, target = "9-month-olds") + 
  labs(title = "Minimizing BIC")
```


## Preset retention criteria

### How many factors to retain?

```{r}
reten_09mo_k <- reten_fun(d_09mo, rot_type = "oblimin")
print(paste("Preset criteria suggest retaining", reten_09mo_k, "factors"))
```

### What are these factors?

```{r}
efa_09mo_k <- fa(d_09mo, reten_09mo_k, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_09mo_k) + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)") 
```

### Which capacities are attributed to 9-month-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_09mo_k, target = "9-month-olds") + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)")
```


# EFA: 5-year-olds

What happens if we limit ourselves to assessments of 5-year-olds' mental capacities?

## Parallel analysis

### How many factors to retain?

```{r}
reten_60mo_PA <- fa.parallel(d_60mo, plot = F); reten_60mo_PA
reten_60mo_par <- reten_60mo_PA$nfact
```

### What are these factors?

```{r}
efa_60mo_par <- fa(d_60mo, reten_60mo_par, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_60mo_par) + 
  labs(title = "Parallel Analysis")
```

### Which capacities are attributed to 5-year-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_60mo_par, target = "5-year-olds") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_60mo_vss <- VSS(d_60mo, plot = F); reten_60mo_vss
reten_60mo_bic <- data.frame(reten_60mo_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_60mo_bic <- fa(d_60mo, reten_60mo_bic, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_60mo_bic) + 
  labs(title = "Minimizing BIC") 
```

### Which capacities are attributed to 5-year-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_60mo_bic, target = "5-year-olds") + 
  labs(title = "Minimizing BIC")
```


## Preset retention criteria

### How many factors to retain?

```{r}
reten_60mo_k <- reten_fun(d_60mo, rot_type = "oblimin")
print(paste("Preset criteria suggest retaining", reten_60mo_k, "factors"))
```

### What are these factors?

```{r}
efa_60mo_k <- fa(d_60mo, reten_60mo_k, "oblimin")
```

```{r, fig.width = 3, fig.asp = 2}
heatmap_fun(efa_60mo_k) + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)") 
```

### Which capacities are attributed to 5-year-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_60mo_k, target = "5-year-olds") + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)")
```


# Demographics

```{r}
ggplot(d_demo, aes(x = Duration/60)) + 
  geom_histogram(binwidth = 2) +
  geom_vline(xintercept = median(d_demo$Duration/60), color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(0, 10000, 4)) +
  labs(title = "Duration of study (according to Qualtrics)",
       subtitle = "Blue dotted line marks median",
       x = "Duration (in minutes)",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = Age)) + 
  geom_histogram(binwidth = 2) +
  geom_vline(xintercept = median(d_demo$Age), color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(0, 10000, 4)) +
  labs(title = "Particpiant age (self-reported)",
       subtitle = "Blue dotted line marks median",
       x = "Age (in years)",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = GenderSex)) + 
  geom_bar() +
  labs(title = "Particpiant gender/sex (self-reported)",
       x = "Gender/sex",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = gsub('(.{1,30})(\\s|$)', '\\1\n', RaceEthnicity_collapse))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant race/ethnicity (self-reported)",
       x = "Race/ethnicity",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = FirstLang)) + 
  geom_bar() +
  labs(title = "Particpiant first language (self-reported)",
       x = "Language",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = factor(Education,
                              levels = levels(d$Education),
                              labels = gsub('(.{1,30})(\\s|$)', '\\1\n', 
                                            levels(d$Education))))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant educational attainment (self-reported)",
       x = "Highest level of education completed",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = Income)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant household income (self-reported)",
       x = "Annual household income",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = HouseholdSize)) + 
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = median(d_demo$HouseholdSize), color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(0, 10000, 1)) +
  labs(title = "Particpiant household size (self-reported)",
       subtitle = "Blue dotted line marks median",
       x = "Number of people in household (adults and children)",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = MaritalStatus)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant marital status (self-reported)",
       x = "Marital status",
       y = "Number of participants")
```

```{r}
ggplot(d_demo, aes(x = Parent)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant parent status (self-reported)",
       subtitle = "'NA' indicates response of 'Prefer not to say'",
       x = "Parent status",
       y = "Number of participants")
```

```{r}
ggplot(d_demo %>% filter(Parent == "Yes"), aes(x = ChildrenNumber)) + 
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = median(d_demo[d_demo$Parent == "Yes",]$ChildrenNumber, na.rm = T), 
             color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(0, 10000, 1)) +
  labs(title = "Number of children among parents (self-reported)",
       subtitle = "Blue dotted line marks median",
       x = "Number of children (among parents)",
       y = "Number of participants")
```

```{r}
ggplot(d_demo %>% filter(Parent == "Yes"), 
       aes(x = factor(ChildrenOldestAge_collapse,
                      levels = levels(d_demo$ChildrenOldestAge_collapse),
                      labels = gsub('(.{1,30})(\\s|$)', '\\1\n', 
                                    levels(d_demo$ChildrenOldestAge_collapse))))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Age of oldest child among parents (self-reported)",
       x = "Age of child in years (among parents)",
       y = "Number of participants")
```

```{r}
ggplot(d_demo %>% filter(Parent == "Yes"), 
       aes(x = factor(ChildrenYoungestAge_collapse,
                      levels = levels(d_demo$ChildrenYoungestAge_collapse),
                      labels = gsub('(.{1,30})(\\s|$)', '\\1\n', 
                                    levels(d_demo$ChildrenYoungestAge_collapse))))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Age of youngest child among parents (self-reported)",
       x = "Age of child in years (among parents)",
       y = "Number of participants")
```


