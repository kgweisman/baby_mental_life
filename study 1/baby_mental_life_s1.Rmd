---
title: "Baby Mental Life: Study 1"
date: 2019-05-15
output: 
  html_notebook:
    toc: true
    toc_float: true
---

```{r global_options, include = F}
knitr::opts_chunk$set(fig.width = 3, fig.asp = 0.67, include = T, echo = F)
```

"Baby Mental Life: Study 1" was conducted on MTurk on 2018-07-31 through 2018-08-01.

Our planned sample was 300 participants, and we anticipated that roughly 85-90% of recruited participants would pass all of our attention checks, so we initially recruited 342 participants (on the idea that ~87.5% of 342 ~ 300 participants; note that for administrative purposes we need to recuit participants in batches that were divisible by 9). After filtering out participants who failed at least one of our attention checks, we ended up retaining only 80% of participants, so we recruited an additional 36 participants for a total of 378 people recruited (on the idea that ~80% of 378 ~ 300 participants; note that for administrative purposes we need to recuit participants in batches that were divisible by 9). In a slight deviation from our preregistered recruitment plan, we limited these additional 36 participants to women, because we had an unexpectedly large imbalance of men to women. 

**UPDATE: On 2018-08-09, KW discovered that there were many repeating GPS locations, a symptom of a recent outbreak of bots on MTurk. As of 2019-05-15, these data _INCLUDE_ participants where there is another participant with an identical set of GPS coordinates as recorded by Qualtrics. Excluding these participants would exclude 76 participants (25%).**

In the end, we ended up with a sample of 301 participants who passed our attention checks, 225 of whom came from unique GPS coordinates.

Each participant assessed children's mental capacities at 3 target ages: newborns, 9-month-olds, and 5-year-olds. For each target, they rated 60 mental capacities on a scale from 0 (not at all capable) to 100 (completely capable). 

For more details about the study, see our preregistration [here](https://osf.io/e6ajh/). 

```{r}
# load required libraries
library(tidyverse)
library(langcog) # source: https://github.com/langcog/langcog-package
library(psych)
library(lme4)

# set theme for ggplots
theme_set(theme_bw())
```

```{r}
# run source code (extra home-made functions)
source("./scripts/max_factors_efa.R")
source("./scripts/plot_fun.R")
source("./scripts/reten_fun.R")
```


# Data preparation

```{r}
# load in de-identified raw data
d0 <- read.csv("./data/deidentified/baby_mental_life_s1_data.csv") %>% select(-X)
```

```{r}
# make question key
question_key <- d0[1,] %>%
  t() %>%
  data.frame() %>%
  rownames_to_column("question_qualtrics") %>%
  rename("question_text" = X1) %>%
  mutate(question = recode(question_qualtrics,
                           "Duration..in.seconds." = "Duration",
                           "Q2" = "Age",
                           "Q3" = "GenderSex",
                           "Q3_3_TEXT" = "GenderSex_fillIn",
                           "Q4" = "EnglishProf",
                           "Q5" = "FirstLang",
                           "Q5_2_TEXT" = "FirstLang_fillIn",
                           "Q18" = "RaceEthnicity",
                           "Q18_10_TEXT" = "RaceEthnicity_fillIn",
                           "Q19" = "Education",
                           "Q20" = "Income",
                           "Q21" = "MaritalStatus",
                           "Q21_6_TEXT" = "MaritalStatus_fillIn",
                           "Q22" = "HouseholdSize",
                           "Q23" = "Parent",
                           "Q25" = "ChildrenNumber",
                           "Q26" = "ChildrenYoungestAge",
                           "Q26_1_TEXT" = "ChildrenYoungestAge_fillIn1",
                           "Q26_2_TEXT" = "ChildrenYoungestAge_fillIn2",
                           "Q27" = "ChildrenOldestAge",
                           "Q27_1_TEXT" = "ChildrenOldestAge_fillIn1",
                           "Q27_2_TEXT" = "ChildrenOldestAge_fillIn2",
                           "Q28" = "Attention",
                           "Q29" = "Comments",
                           .default = question_qualtrics),
         question = case_when(grepl("the following questions", question_text) ~
                                gsub("^.*extent is a ", "", question_text),
                              TRUE ~ question),
         question = case_when(grepl("capable of...", question_text) ~
                                gsub("capable of... ", "", tolower(question)),
                              TRUE ~ question),
         question = gsub(" ", "_", question),
         question = gsub("'", "", question),
         question = gsub("newborn_-_", "target00mo_", question),
         question = gsub("9-month-old_-_", "target09mo_", question),
         question = gsub("5-year-old_-_", "target60mo_", question)) %>%
  mutate(question = gsub("-", "_", question),
         question = gsub(" \\(for_example,_smooth,_rough\\)", "", question))
```

```{r}
# rename questions
d1 <- d0 %>%
  # get rid of extra info in first two rows  
  filter(!is.na(as.numeric(as.character(Q2)))) %>% 
  gather(question_qualtrics, response, -c(ResponseId, duplicateGPS)) %>%
  left_join(question_key %>% select(question_qualtrics, question)) %>%
  select(-question_qualtrics) %>%
  spread(question, response)
```

```{r}
# implement inclusion/exclusion criteria
d2 <- d1 %>%
  filter(Age >= 18, Age <= 45,
         EnglishProf %in% c("Advanced", "Superior"),
         `target00mo_please_select_34` == 34,
         `target09mo_please_select_90` == 90,
         `target60mo_please_select_4` == 4,
         Attention == "Yes")
```

```{r}
# remove people with another identical set of GPS coordinates among people who passed attention checks AS DESIRED
d3 <- d2 %>%
  # filter(duplicateGPS == F) %>%
  select(-duplicateGPS)
```


```{r}
# recode variables & drop extraneous variables
d4 <- d3 %>%
  select(-c(EndDate, Finished, 
            payment, Progress, 
            RecordedDate, StartDate, Status, 
            timeEstimate, UserLanguage)) %>%
  mutate_at(vars(c(starts_with("target"), Age, ChildrenNumber, 
                   ChildrenOldestAge_fillIn1, ChildrenOldestAge_fillIn2, 
                   ChildrenYoungestAge_fillIn1, ChildrenYoungestAge_fillIn2,
                   Duration, HouseholdSize)),
            funs(as.numeric(.))) %>%
  mutate(Education = factor(Education,
                            levels = c("No schooling completed", 
                                       "Nursery school to 8th grade", 
                                       "Some high school, no diploma", 
                                       "High school graduate, diploma or equivalent (including GED)", 
                                       "Some college credit, no degree", 
                                       "Trade school, technical school, or vocational school",
                                       "Associate's degree (for example, AA, AS)",
                                       "Bachelor's degree (for example, BA, BS)",
                                       "Master's degree (for example, MA, MS)",
                                       "Doctor or professional degree (for example, PhD, JD, MD, MBA)")),
         Income = factor(Income,
                         levels = c("$5,001 - 15,000", 
                                    "$15,001 - 30,000", 
                                    "$30,001 - 60,000",
                                    "$60,001 - 90,000",
                                    "$90,001 - 150,000",
                                    "Greater than $150,000",
                                    "Prefer not to say")),
         Parent = factor(Parent,
                         levels = c("No", "Yes")))
```

```{r}
# make useful datasets
# final dataset with all measured variables
d <- d4 %>% distinct()

# demographic information
d_demo <- d %>% 
  select(ResponseId, Duration,
         Age, starts_with("GenderSex"), starts_with("RaceEthnicity"),
         starts_with("FirstLang"),
         Education, Income, HouseholdSize,
         starts_with("MaritalStatus"),
         Parent, starts_with("Children"), 
         Comments) %>%
  mutate(RaceEthnicity_collapse = ifelse(grepl(",([A-Za-z])", RaceEthnicity),
                                         "Multiple", RaceEthnicity)) %>%
  mutate(ChildrenOldestAge_collapse = case_when(
    ChildrenOldestAge %in% c("My oldest child has not yet been born (I am/my partner is pregnant)", "My oldest child is deceased", "Prefer not to say") ~ ChildrenOldestAge,
    ChildrenOldestAge == "In months:" ~ 
      ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenOldestAge_fillIn1)/12 < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    ChildrenOldestAge == "In years:" ~
      ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenOldestAge_fillIn2) < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    TRUE ~ "NA")) %>%
  mutate(ChildrenOldestAge_collapse = 
           factor(ChildrenOldestAge_collapse,
                  levels = c("My oldest child has not yet been born (I am/my partner is pregnant)",
                             "< 1 year",
                             "1 - 3 years",
                             "3 - 5 years",
                             "5 - 10 years",
                             "10 - 18 years",
                             "> 18 years",
                             "My oldest child is deceased",
                             "Prefer not to say"))) %>%
  mutate(ChildrenYoungestAge_collapse = case_when(
    ChildrenYoungestAge %in% c("My youngest child has not yet been born (I am/my partner is pregnant)", "My youngest child is deceased", "Prefer not to say") ~ ChildrenYoungestAge,
    ChildrenYoungestAge == "In months:" ~ 
      ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenYoungestAge_fillIn1)/12 < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    ChildrenYoungestAge == "In years:" ~
      ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 1,
             "< 1 year",
             ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 3, 
                    "1 - 3 years",
                    ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 5, 
                           "3 - 5 years",
                           ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 10, 
                                  "5 - 10 years",
                                  ifelse(as.numeric(ChildrenYoungestAge_fillIn2) < 18, 
                                         "10 - 18 years",
                                         "> 18 years"))))),
    TRUE ~ "NA")) %>%
  mutate(ChildrenYoungestAge_collapse = 
           factor(ChildrenYoungestAge_collapse,
                  levels = c("My Youngest child has not yet been born (I am/my partner is pregnant)",
                             "< 1 year",
                             "1 - 3 years",
                             "3 - 5 years",
                             "5 - 10 years",
                             "10 - 18 years",
                             "> 18 years",
                             "My Youngest child is deceased",
                             "Prefer not to say")))  
# all assessments of ALL TARGETS, RepsonseId as rownames
d_all <- d %>% 
  select(ResponseId, starts_with("target"), -contains("please_select")) %>%
  gather(question, response, -ResponseId) %>%
  mutate(target = gsub("_.*$", "", question),
         capacity = gsub("target..mo_", "", question),
         subid = paste(ResponseId, target, sep = "_")) %>%
  select(-ResponseId, -question, -target) %>%
  spread(capacity, response) %>%
  column_to_rownames("subid")

# all assessments of NEWBORNS, RepsonseId as rownames
d_00mo <- d_all %>% 
  rownames_to_column("subid") %>%
  filter(grepl("target00mo", subid)) %>%
  mutate(subid = gsub("target..mo_", "", subid)) %>%
  column_to_rownames("subid")

# all assessments of 9-MONTH-OLDS, RepsonseId as rownames
d_09mo <- d_all %>% 
  rownames_to_column("subid") %>%
  filter(grepl("target09mo", subid)) %>%
  mutate(subid = gsub("target..mo_", "", subid)) %>%
  column_to_rownames("subid")

# all assessments of 5-YEAR-OLDS, RepsonseId as rownames
d_60mo <- d_all %>% 
  rownames_to_column("subid") %>%
  filter(grepl("target60mo", subid)) %>%
  mutate(subid = gsub("target..mo_", "", subid)) %>%
  column_to_rownames("subid")
```


# EFA: all targets

Our primary analysis is an exploratory factor analysis (EFA) collapsing across all 3 target characters (and treating an individual participant's responses to each character as if they were independent data points) - see the preregistration for more details.  

We planned to examine three factor retention protocols in order to determine how many factors to retain: Parallel analysis, minimizing BIC, and a set of preset criteria outlined in Weisman et al. (2017). Here we look at each solution in turn.

## Rotation choices

We planned to examine oblimin-rotated solutions (which allow factors to correlate), but you could examine other rotation options by selecting a different rotation type here.

```{r}
chosen_rot <- "oblimin" # preregistered: factors allowed to correlate
# chosen_rot <- "varimax" # orthogonal: factors forced not to correlate
# chosen_rot <- "none" # no rotation
```


## Parallel analysis

### How many factors to retain?

```{r}
reten_all_PA <- fa.parallel(d_all, plot = F); reten_all_PA
reten_all_par <- reten_all_PA$nfact
```

### What are these factors?

```{r}
efa_all_par <- fa(d_all, nfactors = reten_all_par, rotate = chosen_rot,
                  scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5, include = T}
heatmap_fun(efa_all_par) + 
  labs(title = paste0("Parallel Analysis (rotation: ", chosen_rot, ")"))
```

```{r, fig.width = 4.5, fig.asp = 1.25, include = F}
heatmap_fun(efa_all_par, factor_names = c("Cognition and control", "Bodily sensations", "Social connection", "Negative affect")) + 
  labs(title = "Study 1: Factor loadings from exploratory factor analysis (EFA)",
       subtitle = "Four-factor solution suggested by parallel analysis, after oblique transformation (oblimin)")
```

```{r, include = F}
# cross-loadings
efa_all_par$loadings[] %>%
  data.frame() %>%
  rownames_to_column("capacity") %>%
  gather(factor, loading, -capacity) %>%
  filter(abs(loading) > 0.4) %>% 
  count(capacity) %>%
  filter(n > 1) %>%
  select(-n) %>%
  left_join(efa_all_par$loadings[] %>%
              data.frame() %>%
              rownames_to_column("capacity") %>%
              gather(factor, loading, -capacity) %>%
              filter(abs(loading) > 0.4) %>%
              mutate(loading = round(loading, 3)) %>%
              spread(factor, loading)) %>%
  rename(COG = MR1, BOD = MR2, POS = MR3, NEG = MR4)
```

```{r}
# interfactor correlations
efa_all_par$Phi %>%
  data.frame() %>%
  rownames_to_column("factorA") %>%
  gather(factorB, phi, -factorA) %>%
  arrange(desc(phi))
```

```{r}
efa_all_par$loadings[] %>%
  data.frame() %>%
  rownames_to_column("capacity") %>%
  gather(factor, loading, -capacity) %>%
  # group_by(capacity) %>%
  # top_n(1, abs(loading)) %>%
  # ungroup() %>%
  filter(abs(loading) >= 0.6) %>%
  count(factor)

efa_all_par$loadings[] %>%
  data.frame() %>%
  rownames_to_column("capacity") %>%
  select(capacity, MR4) %>%
  arrange(desc(abs(MR4)))
```


### Which capacities are attributed to which targets?

```{r, fig.width = 4, fig.asp = 0.6, include = T}
scoresplot_fun(efa_all_par, target = "all (study 1)") + 
  labs(title = "Parallel Analysis") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Here's a multilevel linear regression on these factor scores, with random intercepts and slopes (for target and factor) by participant. Target is coded with linear and quadratic contrasts, and factor is effect-coded for comparison with the grand mean (with the last factor as the base, -1):

```{r, include = T}
efa_all_par_scores <- efa_all_par$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(target = gsub("^.*_target", "target", subid),
         ResponseId = gsub("_target.*$", "", subid)) %>%
  select(-subid) %>%
  gather(factor, score, -target, -ResponseId) %>%
  mutate_at(vars(target, factor), funs(factor))

contrasts(efa_all_par_scores$target) <- contr.poly(3)
contrasts(efa_all_par_scores$factor) <- contr.sum(reten_all_par)

r_all_par <- lmer(score ~ target * factor + (target + factor | ResponseId),
                  efa_all_par_scores)
summary(r_all_par, corr = F)
```

If we consider t-values > 2 to be "significant" and use the plot above to guide our interpretation, here's what we conclude:

- [`(Intercept)`: By definition, because we're using factor scores, which are similar to z-scores, the intercept is ~0.]
- `target.L`: Overall, mental capacity attributions increase with target age.
- `target.Q`: This increase is generally non-linear.
- [`factor1`, `factor2`, ...: By definition, because we're using factor scores, which are similar to z-scores, the differences in means across factors are ~0.]
- `target.L:factor1`: The linear increase is more dramatic (steeper slope) for MR1, compared to other factors. 
- `target.Q:factor1`: The nonlinearity is more dramatic (curvier and/or concave instead of convex curve) for MR1, compared to other factors. 
- `target.L:factor2`: The linear increase is less dramatic (shallower slope) for MR2, compared to other factors. 
- `target.Q:factor2`: The nonlinearity is less dramatic (flatter curve) for MR2, compared to other factors. 
- `target.L:factor3`: The linear increase is more dramatic (steeper slope) for MR3, compared to other factors. 
- `target.Q:factor3`: The nonlinearity is less dramatic (flatter curve) for MR3, compared to other factors. 

```{r, fig.width = 5, fig.asp = 1, include = T}
itemsplot_fun(efa_all_par, target = "all") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_all_vss <- VSS(d_all, plot = F); reten_all_vss
reten_all_bic <- data.frame(reten_all_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_all_bic <- fa(d_all, nfactors = reten_all_bic, rotate = chosen_rot,
                  scores = "tenBerge", impute = "median")
```

```{r, fig.width = 5, fig.asp = 1.5, include = T}
heatmap_fun(efa_all_bic) + 
  labs(title = paste0("Minimizing BIC (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to which targets?

```{r, fig.width = 5, fig.asp = 0.6, include = T}
scoresplot_fun(efa_all_bic, target = "all (study 1)") + 
  labs(title = "Minimizing BIC") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Here's a multilevel linear regression on these factor scores, with random intercepts and slopes (for target and factor) by participant. Target is coded with linear and quadratic contrasts, and factor is effect-coded for comparison with the grand mean (with the last factor as the base, -1):

```{r}
# efa_all_bic_scores <- efa_all_bic$scores[] %>%
#   data.frame() %>%
#   rownames_to_column("subid") %>%
#   mutate(target = gsub("^.*_target", "target", subid),
#          ResponseId = gsub("_target.*$", "", subid)) %>%
#   select(-subid) %>%
#   gather(factor, score, -target, -ResponseId) %>%
#   mutate_at(vars(target, factor), funs(factor))
# 
# contrasts(efa_all_bic_scores$target) <- contr.poly(3)
# contrasts(efa_all_bic_scores$factor) <- contr.sum(reten_all_bic)
# 
# r_all_bic <- lmer(score ~ target * factor + (target + factor | ResponseId),
#                   efa_all_bic_scores,
#                   control = lmerControl(optCtrl = list(maxfun = 100000)))
# summary(r_all_bic, corr = F)
```

If we consider t-values > 2 to be "significant" and use the plot above to guide our interpretation, here's what we conclude:

- [`(Intercept)`: By definition, because we're using factor scores, which are similar to z-scores, the intercept is ~0.]
- `target.L`: Overall, mental capacity attributions increase with target age.
- `target.Q`: This increase is *not* generally non-linear.
- [`factor1`, `factor2`, ...: By definition, because we're using factor scores, which are similar to z-scores, the differences in means across factors are ~0.]
- `target.L:factor1`: The linear increase is more dramatic (steeper slope) for MR1, compared to other factors. 
- `target.Q:factor1`: The nonlinearity is more dramatic (curvier and/or concave instead of convex curve) for MR1, compared to other factors. 
- `target.L:factor2`: The linear increase is less dramatic (shallower slope) for MR2, compared to other factors. 
- `target.Q:factor2`: The nonlinearity for MR2 is comparable to other factors. 
- `target.L:factor3`: The linear increase is more dramatic (steeper slope) for MR3, compared to other factors. 
- `target.Q:factor3`: The nonlinearity is less dramatic (flatter curve) for MR3, compared to other factors. 
- `target.L:factor4`: The linear increase is less dramatic (shallower slope) for MR4, compared to other factors. 
- `target.Q:factor4`: The nonlinearity is more dramatic (curvier and/or concanve instead of convex curve) for MR4, compared to other factors. 
- `target.L:factor5`: The linear increase is more dramatic (steeper slope) for MR5, compared to other factors. 
- `target.Q:factor5`: The nonlinearity is less dramatic (flatter curve) for MR5, compared to other factors. 

```{r, fig.width = 5, fig.asp = 1, include = T}
itemsplot_fun(efa_all_bic, target = "all") + 
  labs(title = "Minimizing BIC")
```

### How do these compare to parallel analysis?

```{r}
efa_all_par$loadings[] %>%
  data.frame() %>%
  rownames_to_column("capacity") %>%
  gather(factor, loading, -capacity) %>%
  group_by(capacity) %>%
  top_n(1, abs(loading)) %>%
  ungroup() %>%
  select(-loading) %>%
  rename(par_factor = factor) %>%
  left_join(efa_all_bic$loadings[] %>%
              data.frame() %>%
              rownames_to_column("capacity") %>%
              gather(factor, loading, -capacity) %>%
              group_by(capacity) %>%
              top_n(1, abs(loading)) %>%
              ungroup() %>%
              select(-loading) %>%
              rename(k_factor = factor)) %>%
  count(par_factor, k_factor) %>%
  spread(k_factor, n)
```

## Preset retention criteria

### How many factors to retain?

```{r}
reten_all_k <- reten_fun(d_all, rot_type = chosen_rot)
print(paste("Preset criteria suggest retaining", reten_all_k, "factors"))
```

### What are these factors?

```{r}
efa_all_k <- fa(d_all, nfactors = reten_all_k, rotate = chosen_rot,
                  scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5, include = T}
heatmap_fun(efa_all_k) + 
  labs(title = paste0("Preset criteria (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to which targets?

```{r, include = T}
scoresplot_fun(efa_all_k, target = "all (study 1)") + 
  labs(title = "Preset factor retention criteria (Weisman et al., 2017)")
```

Here's a multilevel linear regression on these factor scores, with random intercepts and slopes (for target and factor) by participant. Target is coded with linear and quadratic contrasts, and factor is effect-coded for comparison with the grand mean (with the last factor as the base, -1):

```{r, include = T}
efa_all_k_scores <- efa_all_k$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(target = gsub("^.*_target", "target", subid),
         ResponseId = gsub("_target.*$", "", subid)) %>%
  select(-subid) %>%
  gather(factor, score, -target, -ResponseId) %>%
  mutate_at(vars(target, factor), funs(factor))

contrasts(efa_all_k_scores$target) <- contr.poly(3)
contrasts(efa_all_k_scores$factor) <- contr.sum(reten_all_k)

r_all_k <- lmer(score ~ target * factor + (target + factor | ResponseId),
                efa_all_k_scores)
summary(r_all_k, corr = F)
```

**There are some problems with this model that I haven't addressed** - see warnings above. Ignoring them for now... 

If we consider t-values > 2 to be "significant" and use the plot above to guide our interpretation, here's what we conclude:

- [`(Intercept)`: By definition, because we're using factor scores, which are similar to z-scores, the intercept is ~0.]
- `target.L`: Overall, mental capacity attributions increase with target age.
- `target.Q`: This increase is generally non-linear.
- [`factor1`: By definition, because we're using factor scores, which are similar to z-scores, the differences in means across factors are ~0.]
- `target.L:factor1`: The linear increase is more dramatic (steeper slope) for MR1, compared to other factors. 
- `target.Q:factor1`: The nonlinearity is more dramatic (curvier and/or concave instead of convex curve) for MR1, compared to other factors. 

```{r, fig.width = 5, fig.asp = 1, include = T}
itemsplot_fun(efa_all_k, target = "all") + 
  labs(title = "Preset factor retention criteria (Weisman et al., 2017)")
```

### How do these compare to parallel analysis?

```{r}
efa_all_par$loadings[] %>%
  data.frame() %>%
  rownames_to_column("capacity") %>%
  gather(factor, loading, -capacity) %>%
  group_by(capacity) %>%
  top_n(1, abs(loading)) %>%
  ungroup() %>%
  select(-loading) %>%
  rename(par_factor = factor) %>%
  left_join(efa_all_k$loadings[] %>%
              data.frame() %>%
              rownames_to_column("capacity") %>%
              gather(factor, loading, -capacity) %>%
              group_by(capacity) %>%
              top_n(1, abs(loading)) %>%
              ungroup() %>%
              select(-loading) %>%
              rename(k_factor = factor)) %>%
  count(par_factor, k_factor) %>%
  spread(k_factor, n)
```


# EFA: newborns

What happens if we limit ourselves to assessments of newborns' mental capacities?

## Parallel analysis

### How many factors to retain?

```{r}
reten_00mo_PA <- fa.parallel(d_00mo, plot = F); reten_00mo_PA
reten_00mo_par <- reten_00mo_PA$nfact
```

### What are these factors?

```{r}
efa_00mo_par <- fa(d_00mo, nfactors = reten_00mo_par, rotate = chosen_rot,
                  scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_00mo_par) + 
  labs(title = paste0("Parallel Analysis (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to newborns?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_00mo_par, target = "newborns") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_00mo_vss <- VSS(d_00mo, plot = F); reten_00mo_vss
reten_00mo_bic <- data.frame(reten_00mo_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_00mo_bic <- fa(d_00mo, nfactors = reten_00mo_bic, rotate = chosen_rot,
                   scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_00mo_bic) + 
  labs(title = paste0("Minimizing BIC (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to newborns?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_00mo_bic, target = "newborns") + 
  labs(title = "Minimizing BIC")
```


## Preset retention criteria

### How many factors to retain?

```{r}
reten_00mo_k <- reten_fun(d_00mo, rot_type = chosen_rot)
print(paste("Preset criteria suggest retaining", reten_00mo_k, "factors"))
```

### What are these factors?

```{r}
efa_00mo_k <- fa(d_00mo, nfactors = reten_00mo_k, rotate = chosen_rot,
                 scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_00mo_k) + 
  labs(title = paste0("Preset criteria (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to newborns?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_00mo_k, target = "newborns") + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)")
```


# EFA: 9-month-olds

What happens if we limit ourselves to assessments of 9-month-olds' mental capacities?

## Parallel analysis

### How many factors to retain?

```{r}
reten_09mo_PA <- fa.parallel(d_09mo, plot = F); reten_09mo_PA
reten_09mo_par <- reten_09mo_PA$nfact
```

### What are these factors?

```{r}
efa_09mo_par <- fa(d_09mo, nfactors = reten_09mo_par, rotate = chosen_rot,
                   scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_09mo_par) + 
  labs(title = paste0("Parallel analysis (rotation: ", chosen_rot, ")"))
```


### Which capacities are attributed to 9-month-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_09mo_par, target = "9-month-olds") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_09mo_vss <- VSS(d_09mo, plot = F); reten_09mo_vss
reten_09mo_bic <- data.frame(reten_09mo_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_09mo_bic <- fa(d_09mo, nfactors = reten_09mo_bic, rotate = chosen_rot,
                   scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_09mo_bic) + 
  labs(title = paste0("Minimizing BIC (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to 9-month-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_09mo_bic, target = "9-month-olds") + 
  labs(title = "Minimizing BIC")
```


## Preset retention criteria

### How many factors to retain?

```{r}
reten_09mo_k <- reten_fun(d_09mo, rot_type = chosen_rot)
print(paste("Preset criteria suggest retaining", reten_09mo_k, "factors"))
```

### What are these factors?

```{r}
efa_09mo_k <- fa(d_09mo, nfactors = reten_09mo_k, rotate = chosen_rot,
                 scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_09mo_k) + 
  labs(title = paste0("Preset criteria (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to 9-month-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_09mo_k, target = "9-month-olds") + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)")
```


# EFA: 5-year-olds

What happens if we limit ourselves to assessments of 5-year-olds' mental capacities?

## Parallel analysis

### How many factors to retain?

```{r}
reten_60mo_PA <- fa.parallel(d_60mo, plot = F); reten_60mo_PA
reten_60mo_par <- reten_60mo_PA$nfact
```

### What are these factors?

```{r}
efa_60mo_par <- fa(d_60mo, nfactors = reten_60mo_par, rotate = chosen_rot,
                   scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_60mo_par) + 
  labs(title = paste0("Parallel analysis (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to 5-year-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_60mo_par, target = "5-year-olds") + 
  labs(title = "Parallel Analysis")
```


## Minimizing BIC

### How many factors to retain?

```{r}
reten_60mo_vss <- VSS(d_60mo, plot = F); reten_60mo_vss
reten_60mo_bic <- data.frame(reten_60mo_vss$vss.stats %>%
  rownames_to_column("nfactors") %>%
  top_n(-1, BIC) %>%
  select(nfactors))$nfactors %>% as.numeric()
```

### What are these factors?

```{r}
efa_60mo_bic <- fa(d_60mo, nfactors = reten_60mo_bic, rotate = chosen_rot,
                   scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_60mo_bic) + 
  labs(title = paste0("Minimizing BIC (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to 5-year-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_60mo_bic, target = "5-year-olds") + 
  labs(title = "Minimizing BIC")
```


## Preset retention criteria

### How many factors to retain?

```{r}
reten_60mo_k <- reten_fun(d_60mo, rot_type = chosen_rot)
print(paste("Preset criteria suggest retaining", reten_60mo_k, "factors"))
```

### What are these factors?

```{r}
efa_60mo_k <- fa(d_60mo, nfactors = reten_60mo_k, rotate = chosen_rot,
                 scores = "tenBerge", impute = "median")
```

```{r, fig.width = 4, fig.asp = 1.5}
heatmap_fun(efa_60mo_k) + 
  labs(title = paste0("Preset criteria (rotation: ", chosen_rot, ")"))
```

### Which capacities are attributed to 5-year-olds?

```{r, fig.width = 3.5, fig.asp = 2}
itemsplot_fun(efa_60mo_k, target = "5-year-olds") + 
  labs(title = "Preset factor retention criteria\n(Weisman et al., 2017)")
```


# Subset of capacities from Weisman et al. (2017)

```{r}
d_all_wdm2017 <- d_all %>%
  select(being_aware_of_things, feeling_calm, feeling_embarrassed, 
         feeling_guilty, feeling_happy, feeling_loved, feeling_pain, 
         feeling_pleasure, feeling_pride, feeling_sad, feeling_safe, 
         feeling_scared, feeling_tired, getting_angry, getting_hungry, 
         getting_hurt_feelings, having_goals, having_self_control, 
         having_thoughts, having_wants_and_desires, hearing_sounds, 
         making_choices, planning, reasoning_about_things, 
         recognizing_others_emotions, recognizing_somebody_else, 
         remembering_things, seeing, telling_right_from_wrong)
```

```{r}
fa.parallel(d_all_wdm2017)
```

```{r}
VSS(d_all_wdm2017, rotate = "varimax")
```

```{r}
reten_fun(d_all_wdm2017, "varimax")
```

```{r, fig.width = 4, fig.asp = 0.8}
fa(d_all_wdm2017, 3, "varimax") %>% heatmap_fun()
```

```{r, fig.width = 4, fig.asp = 0.8}
fa(d_all_wdm2017, 2, "varimax") %>% heatmap_fun()
```


# Demographics

```{r}
ggplot(d_demo, aes(x = Duration/60)) + 
  geom_histogram(binwidth = 2) +
  geom_vline(xintercept = median(d_demo$Duration/60), color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(0, 10000, 4)) +
  labs(title = "Duration of study (according to Qualtrics)",
       subtitle = "Blue dotted line marks median",
       x = "Duration (in minutes)",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, Duration) %>%
  mutate(Duration = Duration/60) %>%
  summarise(median = median(Duration),
            mean = mean(Duration, na.rm = T),
            sd = sd(Duration, na.rm = T),
            min = min(Duration, na.rm = T),
            max = max(Duration, na.rm = T))
```

```{r}
ggplot(d_demo, aes(x = Age)) + 
  geom_histogram(binwidth = 2) +
  geom_vline(xintercept = median(d_demo$Age), color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(0, 10000, 4)) +
  labs(title = "Particpiant age (self-reported)",
       subtitle = "Blue dotted line marks median",
       x = "Age (in years)",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, Age) %>%
  summarise(median = median(Age),
            mean = mean(Age, na.rm = T),
            sd = sd(Age, na.rm = T),
            min = min(Age, na.rm = T),
            max = max(Age, na.rm = T))
```

```{r, fig.width = 3, fig.asp = 1}
efa_all_par_scores %>%
  mutate(ResponseId = as.character(ResponseId)) %>%
  left_join(d_demo %>% 
              distinct(ResponseId, Age) %>% 
              mutate(ResponseId = as.character(ResponseId))) %>%
  mutate(factor = factor(factor,
                         levels = c("MR1", "MR3", "MR2", "MR4"),
                         labels = c("cognition & control", 
                                    "positive & social emotions",
                                    "bodily sensations",
                                    "negative emotions"))) %>%
  ggplot(aes(x = Age, y = score)) +
  geom_hline(yintercept = 0, lty = 2) +
  facet_grid(factor ~ target, scales = "free") +
  # geom_point(alpha = 0.05) +
  geom_smooth(method = "lm") +
  scale_y_continuous(breaks = seq(-10, 10, 1))
```

```{r}
ggplot(d_demo, aes(x = GenderSex)) + 
  geom_bar() +
  labs(title = "Particpiant gender/sex (self-reported)",
       x = "Gender/sex",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, GenderSex) %>%
  count(GenderSex) %>%
  mutate(prop = round(n/sum(n, na.rm = T), 2))
```

```{r, fig.width = 3, fig.asp = 1}
efa_all_par_scores %>%
  mutate(ResponseId = as.character(ResponseId)) %>%
  left_join(d_demo %>% 
              distinct(ResponseId, GenderSex) %>% 
              mutate(ResponseId = as.character(ResponseId))) %>%
  filter(GenderSex %in% c("Female", "Male")) %>%
  mutate(factor = factor(factor,
                         levels = c("MR1", "MR3", "MR2", "MR4"),
                         labels = c("cognition & control", 
                                    "positive & social emotions",
                                    "bodily sensations",
                                    "negative emotions"))) %>%
  ggplot(aes(x = GenderSex, y = score)) +
  facet_grid(factor ~ target, scales = "free") +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_jitter(alpha = 0.05, height = 0) +
  geom_pointrange(data = . %>% 
                    group_by(target, factor, GenderSex) %>%
                    multi_boot_standard(col = "score") %>%
                    ungroup(),
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper),
                  fatten = 1, color = "blue") +
  scale_y_continuous(breaks = seq(-10, 10, 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r}
ggplot(d_demo, aes(x = gsub('(.{1,30})(\\s|$)', '\\1\n', RaceEthnicity_collapse))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant race/ethnicity (self-reported)",
       x = "Race/ethnicity",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, RaceEthnicity_collapse) %>%
  count(RaceEthnicity_collapse) %>%
  mutate(prop = round(n/sum(n, na.rm = T), 2)) %>%
  arrange(desc(n))
```

```{r}
ggplot(d_demo, aes(x = FirstLang)) + 
  geom_bar() +
  labs(title = "Particpiant first language (self-reported)",
       x = "Language",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, FirstLang) %>%
  count(FirstLang) %>%
  mutate(prop = round(n/sum(n, na.rm = T), 2)) %>%
  arrange(desc(n))
```

```{r}
ggplot(d_demo, aes(x = factor(Education,
                              levels = levels(d$Education),
                              labels = gsub('(.{1,30})(\\s|$)', '\\1\n', 
                                            levels(d$Education))))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant educational attainment (self-reported)",
       x = "Highest level of education completed",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, Education) %>%
  count(Education) %>%
  mutate(prop = round(n/sum(n, na.rm = T), 2))
```

```{r, fig.width = 3, fig.asp = 1}
efa_all_par_scores %>%
  mutate(ResponseId = as.character(ResponseId)) %>%
  left_join(d_demo %>% 
              distinct(ResponseId, Education) %>% 
              mutate(ResponseId = as.character(ResponseId))) %>%
  mutate(factor = factor(factor,
                         levels = c("MR1", "MR3", "MR2", "MR4"),
                         labels = c("cognition & control", 
                                    "positive & social emotions",
                                    "bodily sensations",
                                    "negative emotions")),
         hi_low_ed = case_when(
           as.numeric(Education) < 8 ~ "less than BA",
           as.numeric(Education) >= 8 ~ "BA or more"),
         hi_low_ed = factor(hi_low_ed,
                            levels =c("less than BA", "BA or more"))) %>%
  ggplot(aes(x = hi_low_ed, y = score)) +
  facet_grid(factor ~ target, scales = "free") +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_jitter(alpha = 0.05, height = 0) +
  geom_pointrange(data = . %>% 
                    group_by(target, factor, hi_low_ed) %>%
                    multi_boot_standard(col = "score") %>%
                    ungroup(),
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper),
                  fatten = 1, color = "blue") +
  scale_y_continuous(breaks = seq(-10, 10, 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r}
ggplot(d_demo, aes(x = Income)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant household income (self-reported)",
       x = "Annual household income",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, Income) %>%
  count(Income) %>%
  mutate(prop = round(n/sum(n, na.rm = T), 2))
```

```{r, fig.width = 3, fig.asp = 1}
efa_all_par_scores %>%
  mutate(ResponseId = as.character(ResponseId)) %>%
  left_join(d_demo %>% 
              distinct(ResponseId, Income) %>% 
              mutate(ResponseId = as.character(ResponseId))) %>%
  mutate(factor = factor(factor,
                         levels = c("MR1", "MR3", "MR2", "MR4"),
                         labels = c("cognition & control", 
                                    "positive & social emotions",
                                    "bodily sensations",
                                    "negative emotions")),
         hi_low_inc = case_when(
           as.numeric(Income) < 4 ~ "less than $60,001",
           as.numeric(Income) >= 4 ~ "$60,001 or more"),
         hi_low_inc = factor(hi_low_inc,
                             levels =c("less than $60,001", "$60,001 or more"))) %>%
  filter(!is.na(hi_low_inc)) %>%
  ggplot(aes(x = hi_low_inc, y = score)) +
  facet_grid(factor ~ target, scales = "free") +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_jitter(alpha = 0.05, height = 0) +
  geom_pointrange(data = . %>% 
                    group_by(target, factor, hi_low_inc) %>%
                    multi_boot_standard(col = "score") %>%
                    ungroup(),
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper),
                  fatten = 1, color = "blue") +
  scale_y_continuous(breaks = seq(-10, 10, 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r}
ggplot(d_demo, aes(x = HouseholdSize)) + 
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = median(d_demo$HouseholdSize), color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(0, 10000, 1)) +
  labs(title = "Particpiant household size (self-reported)",
       subtitle = "Blue dotted line marks median",
       x = "Number of people in household (adults and children)",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, HouseholdSize) %>%
  summarise(median = median(HouseholdSize),
            mean = mean(HouseholdSize, na.rm = T),
            sd = sd(HouseholdSize, na.rm = T),
            min = min(HouseholdSize, na.rm = T),
            max = max(HouseholdSize, na.rm = T))
```

```{r}
ggplot(d_demo, aes(x = MaritalStatus)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant marital status (self-reported)",
       x = "Marital status",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, MaritalStatus) %>%
  count(MaritalStatus) %>%
  mutate(prop = round(n/sum(n, na.rm = T), 2))
```

```{r}
ggplot(d_demo, aes(x = Parent)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Particpiant parent status (self-reported)",
       subtitle = "'NA' indicates response of 'Prefer not to say'",
       x = "Parent status",
       y = "Number of participants")
```

```{r}
d_demo %>%
  distinct(ResponseId, Parent) %>%
  count(Parent) %>%
  mutate(prop = round(n/sum(n, na.rm = T), 2))
```

```{r, fig.width = 3, fig.asp = 1}
efa_all_par_scores %>%
  mutate(ResponseId = as.character(ResponseId)) %>%
  left_join(d_demo %>% 
              distinct(ResponseId, Parent) %>% 
              mutate(ResponseId = as.character(ResponseId))) %>%
  filter(!is.na(Parent)) %>%
  mutate(factor = factor(factor,
                         levels = c("MR1", "MR3", "MR2", "MR4"),
                         labels = c("cognition & control", 
                                    "positive & social emotions",
                                    "bodily sensations",
                                    "negative emotions"))) %>%
  ggplot(aes(x = Parent, y = score)) +
  facet_grid(factor ~ target, scales = "free") +
  geom_hline(yintercept = 0, lty = 2) +
  # geom_jitter(alpha = 0.05, height = 0) +
  geom_pointrange(data = . %>% 
                    group_by(target, factor, Parent) %>%
                    multi_boot_standard(col = "score") %>%
                    ungroup(),
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper),
                  fatten = 1, color = "blue") +
  scale_y_continuous(breaks = seq(-10, 10, 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r}
ggplot(d_demo %>% filter(Parent == "Yes"), aes(x = ChildrenNumber)) + 
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = median(d_demo[d_demo$Parent == "Yes",]$ChildrenNumber, na.rm = T), 
             color = "blue", lty = 2) +
  scale_x_continuous(breaks = seq(-1, 10000, 1)) +
  labs(title = "Number of children among parents (self-reported)",
       subtitle = "Blue dotted line marks median",
       x = "Number of children (among parents)",
       y = "Number of participants")
```

```{r}
ggplot(d_demo %>% filter(Parent == "Yes"), 
       aes(x = factor(ChildrenOldestAge_collapse,
                      levels = levels(d_demo$ChildrenOldestAge_collapse),
                      labels = gsub('(.{1,30})(\\s|$)', '\\1\n', 
                                    levels(d_demo$ChildrenOldestAge_collapse))))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Age of oldest child among parents (self-reported)",
       x = "Age of child in years (among parents)",
       y = "Number of participants")
```

```{r}
ggplot(d_demo %>% filter(Parent == "Yes"), 
       aes(x = factor(ChildrenYoungestAge_collapse,
                      levels = levels(d_demo$ChildrenYoungestAge_collapse),
                      labels = gsub('(.{1,30})(\\s|$)', '\\1\n', 
                                    levels(d_demo$ChildrenYoungestAge_collapse))))) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(title = "Age of youngest child among parents (self-reported)",
       x = "Age of child in years (among parents)",
       y = "Number of participants")
```

# Save EFA output

Finally, I'll export the 4-factor EFA results to a saved file that I can draw on in our Study 2 analyses.

```{r}
saveRDS(efa_all_par, file = "./s1_efa.rds")
write.csv(d_demo, file = "./s1_demo.csv")
write.csv(d_all, file = "./s1_data.csv")
```

